# Regras do Projeto - Rodust E-commerce

## üê≥ Ambiente Docker (CR√çTICO)

**SEMPRE execute comandos Artisan dentro dos containers Docker:**
```bash
# ‚úÖ CORRETO - Dentro do container
docker exec docker-laravel.test-1 php artisan <comando>

# ‚ùå ERRADO - Localmente no Windows
php artisan <comando>
```

### Containers Ativos:
- `docker-laravel.test-1` - Aplica√ß√£o Laravel (porta 8000)
- `docker-laravel.queue-1` - Queue Worker (Redis)
- `docker-mysql-1` - MySQL 8.0
- `docker-redis-1` - Redis (porta 6379)
- `docker-wordpress-1` - WordPress (porta 8443)

### Configura√ß√£o de Rede:
- **DB_HOST=mysql** (nome do servi√ßo Docker, N√ÉO use host.docker.internal)
- **DB_PORT=3306** (porta interna, N√ÉO 3307 que √© mapeamento externo)
- **REDIS_HOST=redis** (nome do servi√ßo Docker)
- **CACHE_STORE=redis**
- **QUEUE_CONNECTION=redis**

## üèóÔ∏è Arquitetura

### Stack:
- **Frontend**: WordPress (Tailwind CSS, Gulp, Alpine.js)
- **Backend**: Laravel 11 (API REST)
- **ERP**: Bling API v3 (OAuth2)
- **Queue**: Redis com Laravel Horizon
- **Cache**: Redis

### Integra√ß√£o WordPress ‚Üî Laravel:
- WordPress consome API Laravel via `http://laravel.test`
- Laravel sincroniza produtos/pedidos com Bling
- Jobs enfileirados processados por `laravel.queue-1`

## ‚ö° Particularidades Importantes

### BlingV3Adapter:
- **Lazy Loading de Tokens** - tokens carregados apenas quando necess√°rio (n√£o no construtor)
- Fallback para cache se banco indispon√≠vel (importante para queue worker)
- SSL verification desabilitado: `verify => false` (apenas desenvolvimento)

### Comandos Artisan Customizados:
```bash
# Bling - Sempre executar no container
docker exec docker-laravel.test-1 php artisan bling:fetch-statuses [--clear-cache]
docker exec docker-laravel.test-1 php artisan bling:sync-orders [--limit=N|--all]
docker exec docker-laravel.test-1 php artisan bling:refresh-token
```

### Cache & Queue:
- **SEMPRE limpar cache ap√≥s mudan√ßas em .env ou configs:**
  ```bash
  docker exec docker-laravel.test-1 php artisan config:clear
  docker exec docker-laravel.test-1 php artisan optimize:clear
  ```
- **Reiniciar queue worker ap√≥s mudan√ßas:**
  ```bash
  docker restart docker-laravel.queue-1
  ```

### Jobs Existentes (Redis Queue):
- `SyncProductToWordPress`
- `SyncProductToBling`
- `SyncProductDetailFromBling`
- `SyncOrderToBling`
- `SyncCustomerToBling`
- `SyncCustomerFromBling`

## üîê Bling OAuth2

### Escopos Necess√°rios:
```
12288  = Produtos
20480  = Contatos
28672  = Pedidos
32768  = Situa√ß√µes
```

### Token Management:
- Tokens armazenados: `integrations` table + Redis cache
- Refresh autom√°tico quando expira
- Reconex√£o manual: http://localhost:8000/bling/authorize

### Status do Pedido (OrderStatus enum):
- pending, processing, invoiced, shipped, delivered, cancelled

## üìÅ Estrutura de C√≥digo

### Services:
- `BlingV3Adapter` - Comunica√ß√£o com API Bling
- `BlingStatusService` - Gerenciamento de situa√ß√µes
- `BlingOrderService` - Sincroniza√ß√£o de pedidos

### WordPress Theme (rodust):
- Build: `npm run build` (Gulp)
- Assets: `wordpress/wp-content/themes/rodust/assets/`
- Modular: partials separados para manutenibilidade

## üö´ Erros Comuns a Evitar

1. **Rodar `php artisan` localmente** ‚Üí SEMPRE usar `docker exec`
2. **DB_PORT=3307** ‚Üí Usar **3306** (porta interna)
3. **DB_HOST=host.docker.internal** ‚Üí Usar **mysql** (nome do servi√ßo)
4. **Esquecer `config:clear`** ‚Üí Cache pode manter configs antigas
5. **N√£o reiniciar queue worker** ‚Üí Mudan√ßas em c√≥digo n√£o s√£o aplicadas
6. **Carregar tokens no construtor** ‚Üí Quebra queue worker (usar lazy loading)

## üîÑ Fluxo de Desenvolvimento

1. Fazer mudan√ßas no c√≥digo
2. Se mudou `.env` ou configs: `docker exec docker-laravel.test-1 php artisan config:clear`
3. Se mudou Jobs/Services: `docker restart docker-laravel.queue-1`
4. Se mudou JS/CSS do WordPress: `npm run build` (na pasta do tema)
5. Testar sempre via container, n√£o localmente

## üìä Logs & Debug

```bash
# Laravel logs
docker exec docker-laravel.test-1 tail -f storage/logs/laravel.log

# Queue worker logs
docker logs -f docker-laravel.queue-1

# MySQL logs
docker logs -f docker-mysql-1
```

---

**LEMBRETE**: Este √© um projeto **100% dockerizado**. NUNCA execute comandos PHP/Artisan diretamente no Windows/Host.
